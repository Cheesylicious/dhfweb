<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Schichtplan - DHF-Planer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* (Header, Nav, Main, Card... wie bisher) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f1f5f9; color: #333; }
        header { background: #fff; padding: 15px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        header h1 { margin: 0; color: #0056b3; font-size: 24px; }
        header nav { display: flex; gap: 20px; }
        header nav a { text-decoration: none; color: #333; font-weight: 500; font-size: 16px; padding: 10px; border-radius: 5px; }
        header nav a.active, header nav a:hover { background-color: #f0f5fa; color: #0056b3; }
        #user-info { display: flex; align-items: center; gap: 15px; }
        #logout-btn { background: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; }

        /* (Volle Breite beibehalten) */
        main { padding: 30px; max-width: 100%; box-sizing: border-box; }

        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; }
        .btn-primary { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; }

        .sub-nav { background-color: #fff; padding: 0 30px; border-bottom: 1px solid #ddd; margin-bottom: 30px; }
        .sub-nav a { display: inline-block; padding: 15px 20px; text-decoration: none; color: #555; font-weight: 500; border-bottom: 3px solid transparent; }
        .sub-nav a.active, .sub-nav a:hover { color: #0056b3; border-bottom-color: #0056b3; }

        .plan-nav { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #fcfcfc; border-bottom: 1px solid #eee; }
        .plan-nav h2 { margin: 0; font-size: 22px; }
        .plan-nav-buttons button { padding: 8px 16px; font-size: 15px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; margin-left: 10px; }

        /* --- KORREKTUR: Kein horizontales Scrollen --- */
        #schichtplan-grid-container {
            overflow-x: hidden; /* Scrollen nicht mehr nötig */
        }
        #schichtplan-grid {
            display: grid;
        }
        /* --- ENDE KORREKTUR --- */

        .grid-header, .grid-cell, .grid-user-name, .grid-user-total, .grid-user-dog {
            padding: 10px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            text-align: center;
            font-size: 14px;
            line-height: 1.4;
            /* min-width: 45px; (Entfernt für 1fr) */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grid-header { background: #fcfcfc; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .grid-header.weekend { background-color: #fff8f8; }

        /* KORREKTUR: Sticky Name (bleibt) */
        .grid-user-name {
            font-weight: 600; text-align: left;
            position: sticky; left: 0;
            background: #fcfcfc; z-index: 5;
            border-left: 1px solid #eee;
            /* min-width: 160px; (Entfernt für 'auto') */
        }

        /* KORREKTUR: Diensthund (passt sich Inhalt an) */
        .grid-user-dog { font-weight: 500; text-align: left; background: #fcfcfc; }
        .grid-header-dog { font-weight: 600; background: #fcfcfc; }

        /* KORREKTUR: Stunden (passt sich Inhalt an) */
        .grid-user-total { font-weight: 600; background: #f8f9fa; text-align: center; }
        .grid-header-total { font-weight: 600; background: #f8f9fa; }

        .grid-cell { cursor: pointer; transition: background-color 0.2s; font-weight: 500; }
        .grid-cell.hovered { background-color: #d6eaff !important; box-shadow: inset 0 0 0 2px #007bff; }
        .grid-cell.weekend { background-color: #fff8f8; }

        .plan-legende { padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; background: #fcfcfc; }
        .legende-item { display: flex; align-items: center; gap: 5px; }
        .legende-color { width: 15px; height: 15px; border: 1px solid #ccc; border-radius: 3px; }

        /* (Modal Styling unverändert) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 0; border: 1px solid #888; width: 80%; max-width: 450px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; border-bottom: 1px solid #eee; }
        .modal-header h2 { margin: 0; font-size: 18px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 25px; }
        #shift-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #shift-selection button { padding: 12px; font-size: 15px; font-weight: 600; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background-color: #f9f9f9; }
        #shift-selection button:hover { border-color: #007bff; background-color: #f0f5fa; }
    </style>
</head>
<body>

    <header>
        <h1>DHF-Planer</h1>
        <nav>
            <a href="dashboard.html">Dashboard</a>
            <a href="users.html">Benutzerverwaltung</a>
            <a href="schichtplan.html" class="active">Schichtplan</a>
            <a href="einstellungen.html">Einstellungen</a>
        </nav>
        <div id="user-info">
            <span id="welcome-user"></span>
            <button id="logout-btn">Abmelden</button>
        </div>
    </header>

    <div class="sub-nav">
        <a href="schichtplan.html" class="active">Schichtplan</a>
        <a href="einstellungen.html">Einstellungen</a>
    </div>

    <main>
        <div class="card">
            <div class="plan-nav">
                <button id="prev-month-btn">&laquo; Vorheriger</button>
                <h2 id="current-month-label">Lade...</h2>
                <button id="next-month-btn">Nächster &raquo;</button>
            </div>

            <div id="schichtplan-grid-container">
                <div id="schichtplan-grid">
                    </div>
            </div>

            <div class="plan-legende" id="plan-legende">
                </div>
        </div>
    </main>

    <div id="shift-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="shift-modal-title">Schicht auswählen</h2>
                <span class="close" id="close-shift-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="shift-modal-info"></p>
                <div id="shift-selection"></div>
            </div>
        </div>
    </div>


    <script>
        // --- Globales Setup (unverändert) ---
        const API_URL = 'http://46.224.63.203:5000';
        let user;
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth() + 1;
        let allUsers = [];
        let allShiftTypes = {};
        let currentShifts = {};
        let currentTotals = {};
        let hoveredCellContext = null;
        const shortcutMap = { 't': 'T.', 'n': 'N.', '6': '6', 'f': 'FREI', 'x': 'X', 'u': 'U' };

        const gridContainer = document.getElementById('schichtplan-grid-container');
        const grid = document.getElementById('schichtplan-grid');
        const legend = document.getElementById('plan-legende');
        const monthLabel = document.getElementById('current-month-label');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const shiftModal = document.getElementById('shift-modal');
        const shiftModalTitle = document.getElementById('shift-modal-title');
        const shiftModalInfo = document.getElementById('shift-modal-info');
        const shiftSelection = document.getElementById('shift-selection');
        const closeShiftModalBtn = document.getElementById('close-shift-modal');
        let modalContext = { userId: null, dateStr: null };


        // --- Basis-Funktionen (Logout, Auth-Check) (unverändert) ---
        async function logout() {
            try { await apiFetch('/api/logout', 'POST'); }
            catch (e) { console.error(e); }
            finally {
                localStorage.removeItem('dhf_user');
                window.location.href = 'index.html?logout=true';
            }
        }
        try {
            user = JSON.parse(localStorage.getItem('dhf_user'));
            if (!user || !user.vorname) { throw new Error("Kein User"); }
            document.getElementById('welcome-user').textContent = `Willkommen, ${user.vorname}!`;
        } catch (e) {
            logout();
        }
        document.getElementById('logout-btn').onclick = logout;

        // --- Globale API-Funktion (unverändert) ---
        async function apiFetch(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
            if (body) { options.body = JSON.stringify(body); }
            const response = await fetch(API_URL + endpoint, options);
            if (response.status === 401 || response.status === 403) { logout(); throw new Error('Sitzung ungültig oder fehlende Rechte.'); }
            const contentType = response.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) { data = await response.json(); } else { data = { message: await response.text() }; }
            if (!response.ok) { throw new Error(data.message || 'API-Fehler'); }
            return data;
        }

        // --- MODAL-LOGIK (unverändert) ---
        function closeModal(modalEl) {
            modalEl.style.display = 'none';
        }
        function openShiftModal(userId, dateStr, userName) {
            const d = new Date(dateStr);
            const dateDisplay = d.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit' });
            modalContext = { userId, dateStr };
            shiftModalTitle.textContent = "Schicht zuweisen";
            shiftModalInfo.textContent = `Für: ${userName} am ${dateDisplay}`;
            shiftModal.style.display = 'block';
        }
        closeShiftModalBtn.onclick = () => closeModal(shiftModal);
        window.onclick = (event) => {
            if (event.target == shiftModal) closeModal(shiftModal);
        }

        // --- HAUPT-RENDER-LOGIK (Angepasst) ---

        async function renderGrid() {
            // (API-Aufrufe bleiben unverändert)
            monthLabel.textContent = "Lade...";
            grid.innerHTML = '<div style="padding: 20px; text-align: center;">Lade Daten...</div>';
            try {
                // (API gibt {shifts, totals} zurück)
                const shiftDataPromise = apiFetch(`/api/shifts?year=${currentYear}&month=${currentMonth}`);
                const userDataPromise = apiFetch('/api/users');
                const typeDataPromise = Object.keys(allShiftTypes).length > 0 ? Promise.resolve(Object.values(allShiftTypes)) : apiFetch('/api/shifttypes');
                const [shiftPayload, userData, typeData] = await Promise.all([shiftDataPromise, userDataPromise, typeDataPromise]);

                allUsers = userData;
                if (Object.keys(allShiftTypes).length === 0) {
                    typeData.forEach(st => allShiftTypes[st.id] = st);
                }
                currentShifts = {};
                shiftPayload.shifts.forEach(s => {
                    const key = `${s.user_id}-${s.date}`;
                    currentShifts[key] = s;
                });
                currentTotals = shiftPayload.totals;
                buildGridDOM();
            } catch (error) {
                grid.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Fehler beim Laden des Plans: ${error.message}</div>`;
            }
        }

        function buildGridDOM() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const monthName = new Date(currentYear, currentMonth - 1, 1).toLocaleString('de-DE', { month: 'long', year: 'numeric' });
            monthLabel.textContent = monthName;

            // --- KORREKTUR: Grid-Spalten (flexibel) ---
            // (auto = passt sich Inhalt an, 1fr = flexibler Restplatz)
            grid.style.gridTemplateColumns = `auto auto repeat(${daysInMonth}, 1fr) auto`;
            grid.innerHTML = '';

            const weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

            // --- ZEILE 1: Wochentage ---
            grid.appendChild(document.createElement('div')); // Ecke (Name)
            grid.appendChild(document.createElement('div')); // Ecke (Hund)
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(currentYear, currentMonth - 1, day);
                const dayName = weekdays[d.getDay()];
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const headerCell = document.createElement('div');
                headerCell.className = 'grid-header' + (isWeekend ? ' weekend' : '');
                headerCell.textContent = dayName;
                grid.appendChild(headerCell);
            }
            grid.appendChild(document.createElement('div')); // Ecke (Stunden)

            // --- ZEILE 2: Tage ---
            grid.appendChild(document.createElement('div')); // Ecke (Name)
            const dogHeader = document.createElement('div');
            dogHeader.className = 'grid-header-dog';
            dogHeader.textContent = 'Diensthund';
            grid.appendChild(dogHeader);
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(currentYear, currentMonth - 1, day);
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const headerCell = document.createElement('div');
                headerCell.className = 'grid-header' + (isWeekend ? ' weekend' : '');
                headerCell.textContent = day;
                grid.appendChild(headerCell);
            }
            const totalHeader = document.createElement('div');
            totalHeader.className = 'grid-header-total';
            totalHeader.textContent = 'Std.';
            grid.appendChild(totalHeader);

            // --- DATEN-ZEILEN (User + Schichten) ---
            const visibleUsers = allUsers.filter(user => user.shift_plan_visible === true);

            visibleUsers.forEach(user => {
                const nameCell = document.createElement('div');
                nameCell.className = 'grid-user-name';
                nameCell.textContent = `${user.vorname} ${user.name}`;
                grid.appendChild(nameCell);

                const dogCell = document.createElement('div');
                dogCell.className = 'grid-user-dog';
                dogCell.textContent = user.diensthund || '---';
                grid.appendChild(dogCell);

                // Schicht-Zellen
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(currentYear, currentMonth - 1, day);
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    const dateStr = d.toISOString().split('T')[0];
                    const key = `${user.id}-${dateStr}`;

                    const shift = currentShifts[key];
                    const shiftType = shift ? allShiftTypes[shift.shifttype_id] : null;

                    const cell = document.createElement('div');
                    cell.className = 'grid-cell' + (isWeekend ? ' weekend' : '');
                    cell.dataset.key = key;

                    if(shiftType) {
                        cell.textContent = shiftType.abbreviation;
                        cell.style.backgroundColor = shiftType.color;
                        if (shiftType.color === '#5D6D7E') cell.style.color = 'white';
                    } else {
                        cell.textContent = '---';
                    }

                    cell.onclick = () => {
                        openShiftModal(user.id, dateStr, `${user.vorname} ${user.name}`);
                    };

                    cell.onmouseenter = () => {
                        cell.classList.add('hovered');
                        hoveredCellContext = {
                            userId: user.id, dateStr: dateStr,
                            userName: `${user.vorname} ${user.name}`,
                            cellElement: cell
                        };
                    };
                    cell.onmouseleave = () => {
                        cell.classList.remove('hovered');
                        hoveredCellContext = null;
                    };

                    grid.appendChild(cell);
                }

                // Stunden-Summen-Zelle
                const totalCell = document.createElement('div');
                totalCell.className = 'grid-user-total';
                totalCell.id = `total-hours-${user.id}`;
                const userTotalHours = currentTotals[user.id] || 0.0;
                totalCell.textContent = userTotalHours.toFixed(1);
                grid.appendChild(totalCell);
            });
        }

        // (populateStaticElements - unverändert)
        async function populateStaticElements() {
            if (Object.keys(allShiftTypes).length === 0) {
                const typeData = await apiFetch('/api/shifttypes');
                typeData.forEach(st => allShiftTypes[st.id] = st);
            }

            legend.innerHTML = '<b>Legende:</b>';
            shiftSelection.innerHTML = '';

            Object.values(allShiftTypes).forEach(st => {
                const item = document.createElement('div');
                item.className = 'legende-item';
                item.innerHTML = `<div class="legende-color" style="background-color: ${st.color};"></div> ${st.abbreviation} (${st.name})`;
                legend.appendChild(item);

                const btn = document.createElement('button');
                btn.textContent = `${st.abbreviation} (${st.name})`;
                btn.style.backgroundColor = st.color;
                if (st.color === '#5D6D7E') btn.style.color = 'white';
                btn.onclick = () => saveShift(st.id, modalContext.userId, modalContext.dateStr);
                shiftSelection.appendChild(btn);
            });
        }

        // --- DATEN SPEICHERN (Bugfix-Logik von app.py implementiert) ---
        async function saveShift(shifttypeId, userId, dateStr) {
            // (Diese Funktion ist bereits korrekt und nutzt den Bugfix aus app.py)
            if (!userId || !dateStr) return;

            const key = `${userId}-${dateStr}`;
            const cell = findCellByKey(key);

            try {
                if(cell) cell.textContent = '...';

                const savedData = await apiFetch('/api/shifts', 'POST', {
                    user_id: userId,
                    date: dateStr,
                    shifttype_id: shifttypeId
                });

                closeModal(shiftModal);

                // KORREKTUR: 'cell.textContent' für FREI/Gelöscht
                if (savedData.message && (savedData.message.includes("gelöscht") || savedData.message.includes("bereits Frei"))) {
                    currentShifts[key] = null;
                    if (cell) {
                        cell.textContent = '---';
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                    }
                } else {
                    const shiftType = allShiftTypes[savedData.shifttype_id];
                    currentShifts[key] = savedData;
                    if (cell) {
                        cell.textContent = shiftType.abbreviation;
                        cell.style.backgroundColor = shiftType.color;
                        cell.style.color = (shiftType.color === '#5D6D7E') ? 'white' : '';
                    }
                }

                // BUGFIX: Stundensumme direkt aus API-Antwort aktualisieren
                const totalCell = document.getElementById(`total-hours-${userId}`);
                if (totalCell) {
                    totalCell.textContent = (savedData.new_total_hours || 0.0).toFixed(1);
                }

            } catch (error) {
                if (cell) cell.textContent = 'Fehler!';
                alert(`Fehler beim Speichern: ${error.message}`);
                if (shiftModal.style.display === 'block') {
                    shiftModalInfo.textContent = `Fehler: ${error.message}`;
                }
            }
        }

        // --- BUGFIX: ZIEL-FINDUNG KORRIGIERT ---
        function findCellByKey(key) {
            // Diese Methode ist robust und findet die Zelle über ihre ID
            return grid.querySelector(`[data-key="${key}"]`);
        }
        // --- ENDE BUGFIX ---

        // --- NAVIGATIONS-EVENTS (unverändert) ---
        prevMonthBtn.onclick = () => {
            currentMonth--;
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            renderGrid();
        };
        nextMonthBtn.onclick = () => {
            currentMonth++;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            renderGrid();
        };

        // --- KEYBOARD SHORTCUT LISTENER (unverändert) ---
        window.addEventListener('keydown', async (event) => {
            if (shiftModal.style.display === 'block') return;
            if (!hoveredCellContext || !hoveredCellContext.userId) return;
            const key = event.key.toLowerCase();
            const abbrev = shortcutMap[key];
            if (abbrev !== undefined) {
                event.preventDefault();
                const shiftType = Object.values(allShiftTypes).find(st => st.abbreviation === abbrev);
                if (shiftType) {
                    await saveShift(shiftType.id, hoveredCellContext.userId, hoveredCellContext.dateStr);
                } else {
                    console.warn(`Shortcut "${key}" (Abk.: "${abbrev}") nicht in allShiftTypes gefunden.`);
                }
            }
        });

        // --- Initialisierung ---
        async function initialize() {
            await populateStaticElements();
            await renderGrid();
        }

        initialize();

    </script>
</body>
</html>