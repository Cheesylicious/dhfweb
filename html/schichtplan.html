<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Schichtplan - DHF-Planer</title>
    <meta name="viewport" content="width=1200">
    <style>
        /* Import einer modernen Schriftart */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: #1a1a1a; /* DUNKLER HINTERGRUND (BLEIBT) */
            color: #ffffff;
            overflow-x: hidden;
        }

        /* Das Canvas-Element für die Animation (BLEIBT) */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Header (Glas-Effekt) (BLEIBT) */
        header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { margin: 0; color: #ffffff; font-size: 24px; }
        header nav { display: flex; gap: 20px; align-items: center; }
        header nav a {
            text-decoration: none; color: #bdc3c7; font-weight: 500; font-size: 16px;
            padding: 10px; border-radius: 5px; transition: background-color 0.3s, color 0.3s;
        }
        header nav a.active, header nav a:hover {
            background-color: rgba(255, 255, 255, 0.1); color: #ffffff;
        }
        #user-info { display: flex; align-items: center; gap: 15px; color: #bdc3c7; }
        #logout-btn {
            background: #e74c3c; color: white; padding: 10px 15px; border: none;
            border-radius: 5px; cursor: pointer; font-size: 15px; transition: background-color 0.3s;
        }
        #logout-btn:hover { background: #c0392b; }

        /* Main (Volle Breite) (BLEIBT) */
        main {
            padding: 30px;
            max-width: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* Card (ZURÜCK ZU WEISS) */
        .card {
            background: #fff;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* Sub-Nav (Glas-Effekt) (BLEIBT) */
        .sub-nav {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0 30px;
            margin-bottom: 30px;
            margin-top: -1px;
            display: flex;
            align-items: center;
            position: relative;
            z-index: 100000;
        }
        .sub-nav a {
            display: inline-block; padding: 15px 20px; text-decoration: none;
            color: #bdc3c7; font-weight: 500; border-bottom: 3px solid transparent;
            transition: color 0.3s;
        }
        .sub-nav a.active, .sub-nav a:hover {
            color: #ffffff;
            border-bottom-color: #3498db;
        }

        /* Dropdown-Menü (KORRIGIERT) */
        .dropdown {
            position: relative;
            display: inline-block;
            z-index: 100001;
        }
        .dropdown .dropbtn {
            font-family: 'Poppins', sans-serif;
            text-decoration: none; color: #bdc3c7; font-weight: 500; font-size: 16px;
            padding: 15px 20px; background: none; border: none; cursor: pointer;
            border-bottom: 3px solid transparent; transition: color 0.3s;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100002;
            border-radius: 5px;
            margin-top: 0px;
            left: 0;
        }
        .dropdown-content a {
            color: #bdc3c7;
            padding: 12px 16px; text-decoration: none; display: block;
            font-size: 15px; border-bottom: none; transition: background-color 0.3s, color 0.3s;
        }
        .dropdown-content a:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .dropdown:hover .dropdown-content { display: block; }
        .dropdown:hover .dropbtn, .dropbtn.active {
            color: #ffffff;
            border-bottom-color: #3498db;
        }
        .dropdown-content a.active {
            background-color: rgba(52, 152, 219, 0.2);
            font-weight: 600;
            color: #3498db;
        }

        /* --- Grid Styles --- */

        .plan-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px;
            background-color: #fcfcfc;
            border-bottom: 1px solid #eee;
        }
        .plan-nav h2 { margin: 0; font-size: 22px; color: #333; }
        .plan-nav button {
            padding: 8px 16px; font-size: 15px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            color: #333;
            border-radius: 5px; cursor: pointer; margin-left: 10px;
        }
        .plan-nav button:hover {
            background: #e0e0e0;
        }

        /* (Kein Speicher-Button in dieser Version) */
        #save-staffing-order-btn { display: none; }


        /* --- ANPASSUNG (Regel 1): Wrapper übernimmt Scrollen --- */
        #unified-grid-wrapper {
            overflow-x: auto;
        }

        /* ALT: Container scrollt nicht mehr selbst */
        #schichtplan-grid-container {
            /* overflow-x: auto; */ /* <-- ENTFERNT */
        }
        #schichtplan-grid {
            display: grid;
        }
        /* --- ENDE ANPASSUNG --- */


        /* --- ANPASSUNG: "Ü"-Spalten hinzugefügt --- */
        .grid-header, .grid-cell, .grid-user-name, .grid-user-total, .grid-user-dog, .grid-header-uebertrag, .grid-user-uebertrag {
            padding: 10px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            text-align: center; font-size: 14px; line-height: 1.4;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            color: #333;
        }

        .grid-header {
            background: #fcfcfc;
            font-weight: 600; position: sticky; top: 0; z-index: 1;
        }

        .grid-header.weekend { background-color: var(--weekend-bg-color, #fff8f8); color: var(--weekend-text-color, #333); }
        .grid-cell.weekend { background-color: var(--weekend-bg-color, #fff8f8); color: var(--weekend-text-color, #333); }

        /* --- ANPASSUNG (Regel 1) --- */
        /* Feiertag (Holiday) färbt die GESAMTE Spalte (Header + Zellen) */
        .day-color-holiday { background-color: var(--holiday-bg-color, #ffddaa) !important; color: var(--text-color, #333); }
        .grid-header.day-color-holiday { color: var(--text-color, #333); }

        /* Training/Schießen färbt NUR den Header */
        .grid-header.day-color-training { background-color: var(--training-bg-color, #daffdb) !important; color: var(--text-color, #333); }
        .grid-header.day-color-shooting { background-color: var(--shooting-bg-color, #ffb0b0) !important; color: var(--text-color, #333); }
        /* --- ENDE ANPASSUNG --- */

        .grid-user-name {
            font-weight: 600; text-align: left;
            position: sticky; left: 0;
            background: #fcfcfc;
            z-index: 5;
            border-left: 1px solid #eee;
        }

        .grid-user-dog { font-weight: 500; text-align: left; background: #fcfcfc; color: #555; }
        .grid-header-dog { font-weight: 600; background: #fcfcfc; }

        /* --- NEU: Stile für "Ü"-Spalte --- */
        .grid-header-uebertrag {
            font-weight: 600;
            background: #ffe8cc; /* Orange-Hintergrund */
            color: #8c5a00; /* Dunklerer Text für Kontrast */
            position: sticky;
            top: 0;
            z-index: 1;
            border-right: 1px solid #ffcc99;
        }
        .grid-user-uebertrag {
            font-weight: 500;
            text-align: center;
            background: #fff3e6; /* Helleres Orange */
            color: #333;
            box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.1);
            border-right: 1px solid #ffcc99; /* Akzent-Rand */
        }
        /* --- ENDE NEU --- */

        .grid-user-total { font-weight: 600; background: #f8f9fa; text-align: center; }
        .grid-header-total { font-weight: 600; background: #f8f9fa; }

        .grid-cell {
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        body:not(.admin-mode) .grid-cell { cursor: default; }

        .grid-cell.hovered {
            background-color: #d6eaff !important;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
            z-index: 20;
        }

        body.visitor-mode .grid-cell {
            cursor: default;
        }

        .grid-cell.violation {
            box-shadow: inset 0 0 0 3px #e74c3c !important;
            border: 1px solid #e74c3c !important;
        }

        .plan-legende {
            padding: 20px; display: flex; flex-wrap: wrap; gap: 15px;
            background: #fcfcfc;
            color: #333;
            border-top: 1px solid #eee;
        }
        .plan-legende b { color: #333; }
        .legende-item { display: flex; align-items: center; gap: 5px; }
        .legende-color { width: 15px; height: 15px; border: 1px solid #ccc; border-radius: 3px; }

        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            color: #333;
            margin: 15% auto; padding: 0; border: 1px solid #888;
            width: 80%; max-width: 450px; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 25px; border-bottom: 1px solid #eee;
        }
        .modal-header h2 { margin: 0; font-size: 18px; color: #333; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 25px; color: #333; }

        #shift-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #shift-selection button {
            padding: 12px; font-size: 15px; font-weight: 600;
            border: 1px solid #ccc;
            border-radius: 5px; cursor: pointer;
            background-color: #f9f9f9;
            color: #333;
        }
        #shift-selection button:hover {
            border-color: #007bff;
            background-color: #f0f5fa;
        }
        body.visitor-mode #shift-modal {
            display: none !important;
        }

        /* --- NEU: STILE FÜR MINDESTBESETZUNG --- */

        /* --- ANPASSUNG (Regel 1): Wrapper übernimmt Scrollen --- */
        #staffing-grid-container {
            /* overflow-x: auto; */ /* <-- ENTFERNT */
            border-top: 2px solid #3498db;
            padding-top: 5px;
            background: #fdfdfd;
        }
        /* --- ENDE ANPASSUNG --- */

        #staffing-grid {
            display: grid;
        }

        .staffing-header, .staffing-cell, .staffing-label, .staffing-total-header {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            text-align: center;
            font-size: 13px;
            line-height: 1.3;
            white-space: nowrap;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .staffing-label {
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            background: #fcfcfc;
            z-index: 4;
            border-left: 1px solid #eee;
        }
        .staffing-total-header {
            position: sticky;
            top: auto;
            z-index: 1;
            background: #f8f9fa;
            font-weight: 600;
        }
        .staffing-header {
            background: #fcfcfc;
            font-weight: 600;
            position: sticky;
            top: auto;
            z-index: 1;
        }
        .staffing-cell {
            font-weight: 500;
            font-size: 14px;
        }
        .staffing-cell.weekend { background-color: var(--weekend-bg-color, #fff8f8); }
        .staffing-header.weekend { background-color: var(--weekend-bg-color, #fff8f8); }

        .staffing-ok {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: 700;
        }
        .staffing-warning {
            background-color: #fff3cd !important;
            color: #856404;
            font-weight: 700;
        }
        .staffing-violation {
            background-color: #ffcccc !important;
            color: #c00000;
            font-weight: 700;
            box-shadow: inset 0 0 0 1px #e74c3c;
        }

        .staffing-untracked {
            background-color: #f8f9fa !important;
            color: #bbb;
        }
        /* --- ENDE NEUE STILE --- */


        /* --- KORREKTUR: Hervorhebung für den eigenen Benutzer --- */

        /* Die Info-Zellen (Name, Hund, Ü, Total) bekommen einen blauen Hintergrund */
        .grid-user-name.current-user-row {
            /* !important wird benötigt, um .fcfcfc (sticky bg) zu überschreiben */
            background-color: #eaf2ff !important;
            border-left: 2px solid #3498db; /* Linker Rahmen */
        }
        .grid-user-dog.current-user-row {
            background-color: #f4f8ff !important;
        }
        .grid-user-uebertrag.current-user-row {
            /* !important wird benötigt, um .fff3e6 (orange) zu überschreiben */
            background-color: #eaf2ff !important;
        }
        .grid-user-total.current-user-row {
            background-color: #eaf2ff !important;
            border-right: 2px solid #3498db; /* Rechter Rahmen */
        }

        /* ALLE Zellen der Zeile (auch die .grid-cell) bekommen den "Spalt"-Rahmen */
        .grid-user-name.current-user-row,
        .grid-user-dog.current-user-row,
        .grid-user-uebertrag.current-user-row,
        .grid-cell.current-user-row,
        .grid-user-total.current-user-row {
            border-top: 2px solid #3498db;
            border-bottom: 2px solid #3498db;
            /* (Justierung, damit die Zelle nicht höher wird als andere) */
            padding-top: 8px;
            padding-bottom: 8px;
        }
        /* --- ENDE KORREKTUR --- */

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <header>
        <h1>DHF-Planer</h1>
        <nav>
            <a href="dashboard.html" id="nav-dashboard" style="display: none;">Dashboard</a>
            <a href="users.html" id="nav-users" style="display: none;">Benutzerverwaltung</a>
            <a href="schichtplan.html" class="active">Schichtplan</a>
        </nav>
        <div id="user-info">
            <span id="welcome-user"></span>
            <button id="logout-btn">Abmelden</button>
        </div>
    </header>

    <div class="sub-nav">
        <a href="schichtplan.html" class="active">Schichtplan</a>
        <div class="dropdown" id="settings-dropdown">
            <button class="dropbtn">Einstellungen &raquo;</button>
            <div class="dropdown-content" id="settings-dropdown-content">
                <a href="einstellungen.html" class="admin-only">Mitarbeiter Sortierung</a>
                <a href="schichtarten.html" class="admin-only">Schichtarten</a>
                <a href="shortcuts.html" class="admin-only">Shortcuts</a>
                <a href="feiertage.html" class="admin-only">Feiertage & Sondertermine</a>
                <a href="farbeeinstellungen.html" class="admin-only">Farbeinstellungen</a> </div>
        </div>
    </div>

    <main>
        <div class="card">
            <div class="plan-nav">
                <button id="prev-month-btn">&laquo; Vorheriger</button>
                <h2 id="current-month-label">Lade...</h2>
                <div class="nav-buttons">
                    <button id="save-staffing-order-btn">Sortierung speichern</button>
                    <button id="next-month-btn">Nächster &raquo;</button>
                </div>
            </div>

            <div id="unified-grid-wrapper">

                <div id="schichtplan-grid-container">
                    <div id="schichtplan-grid">
                        </div>
                </div>

                <div id="staffing-grid-container">
                     <div id="staffing-grid">
                        </div>
                </div>

            </div> <div class="plan-legende" id="plan-legende">
                </div>
        </div>
    </main>

    <div id="shift-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="shift-modal-title">Schicht auswählen</h2>
                <span class="close" id="close-shift-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="shift-modal-info"></p>
                <div id="shift-selection"></div>
            </div>
        </div>
    </div>


    <script>
        // --- START: PARTIKEL-ANIMATION (unverändert) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        const nodeColor = '#3498db';
        const lineColor = '#ecf0f1';
        let particlesArray;
        function setCanvasSize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        setCanvasSize();
        class Particle {
            constructor(x, y, directionX, directionY, size) { this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = nodeColor; ctx.fill(); }
            update() { if (this.x > canvas.width || this.x < 0) { this.directionX = -this.directionX; } if (this.y > canvas.height || this.y < 0) { this.directionY = -this.directionY; } this.x += this.directionX; this.y += this.directionY; this.draw(); }
        }
        function init() {
            particlesArray = []; let numberOfParticles = (canvas.height * canvas.width) / 9000; if (numberOfParticles > 100) numberOfParticles = 100;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 1; let x = (Math.random() * ((canvas.width - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((canvas.height - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * 0.4) - 0.2; let directionY = (Math.random() * 0.4) - 0.2;
                particlesArray.push(new Particle(x, y, directionX, directionY, size));
            }
        }
        function connect() {
            let maxDistance = 150; ctx.strokeStyle = lineColor;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                    if (distance < (maxDistance * maxDistance)) { let opacity = 1 - (distance / (maxDistance * maxDistance)); ctx.globalAlpha = opacity; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke(); }
                }
            }
            ctx.globalAlpha = 1.0;
        }
        function animate() { requestAnimationFrame(animate); ctx.clearRect(0, 0, canvas.width, canvas.height); for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); } connect(); }
        window.addEventListener('resize', () => { setCanvasSize(); init(); });
        init(); animate();
        // --- ENDE: PARTIKEL-ANIMATION ---
    </script>

    <script>
        // --- Globales Setup ---
        const API_URL = 'http://46.224.63.203:5000';
        const SHORTCUT_STORAGE_KEY = 'dhf_shortcuts';
        const COLOR_STORAGE_KEY = 'dhf_color_settings';
        let loggedInUser; // <-- ANPASSUNG (Regel 2): Umbenannt von 'user'
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth() + 1;
        let allUsers = [];
        let allShiftTypes = {};
        let currentShifts = {};
        let currentShiftsLastMonth = {};
        let currentTotals = {};
        let currentViolations = new Set();
        let currentSpecialDates = {};
        let colorSettings = {};
        let hoveredCellContext = null;

        let currentStaffingActual = {};

        let shortcutMap = {};
        const defaultShortcuts = { 'T.': 't', 'N.': 'n', '6': '6', 'FREI': 'f', 'X': 'x', 'U': 'u' };
        let isVisitor = false;
        let isAdmin = false;

        let staffingSortable = null;

        const DEFAULT_COLORS = {
            'weekend_bg_color': '#fff8f8',
            'weekend_text_color': '#333333',
            'holiday_bg_color': '#ffddaa',
            'training_bg_color': '#daffdb',
            'shooting_bg_color': '#ffb0b0'
        };


        const gridContainer = document.getElementById('schichtplan-grid-container');
        const grid = document.getElementById('schichtplan-grid');
        const staffingGridContainer = document.getElementById('staffing-grid-container');
        const staffingGrid = document.getElementById('staffing-grid');
        const legend = document.getElementById('plan-legende');
        const monthLabel = document.getElementById('current-month-label');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const saveStaffingOrderBtn = document.getElementById('save-staffing-order-btn');

        const shiftModal = document.getElementById('shift-modal');
        const shiftModalTitle = document.getElementById('shift-modal-title');
        const shiftModalInfo = document.getElementById('shift-modal-info');
        const shiftSelection = document.getElementById('shift-selection');
        const closeShiftModalBtn = document.getElementById('close-shift-modal');
        let modalContext = { userId: null, dateStr: null };

        const COL_WIDTH_NAME = 'minmax(150px, 1.5fr)';
        const COL_WIDTH_DETAILS = 'minmax(80px, 1fr)';
        const COL_WIDTH_UEBERTRAG = 'minmax(50px, 0.5fr)';
        const COL_WIDTH_DAY = 'minmax(45px, 1fr)';
        const COL_WIDTH_TOTAL = 'minmax(60px, 0.5fr)';


        // --- Basis-Funktionen (Logout, Auth-Check) (ANGEPASST) ---
        async function logout() {
            try { await apiFetch('/api/logout', 'POST'); }
            catch (e) { console.error(e); }
            finally {
                localStorage.removeItem('dhf_user');
                window.location.href = 'index.html?logout=true';
            }
        }
        try {
            // --- ANPASSUNG (Regel 2): 'user' -> 'loggedInUser' ---
            loggedInUser = JSON.parse(localStorage.getItem('dhf_user'));
            if (!loggedInUser || !loggedInUser.vorname || !loggedInUser.role) { throw new Error("Kein User"); }
            document.getElementById('welcome-user').textContent = `Willkommen, ${loggedInUser.vorname}!`;

            isAdmin = loggedInUser.role.name === 'admin';
            isVisitor = loggedInUser.role.name === 'Besucher';
            // --- ENDE ANPASSUNG ---

            const navDashboard = document.getElementById('nav-dashboard');
            const navUsers = document.getElementById('nav-users');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const settingsDropdownContent = document.getElementById('settings-dropdown-content');

            // --- ANPASSUNG (Regel 2): 'user' -> 'loggedInUser' ---
            if (isAdmin || loggedInUser.role.name === 'user') {
                 navDashboard.style.display = 'block';
            }
            // --- ENDE ANPASSUNG ---
            if (isAdmin) {
                navUsers.style.display = 'block';
            }
            if (isVisitor) {
                isVisitor = true;
                document.body.classList.add('visitor-mode');
                navDashboard.style.display = 'none';
                navUsers.style.display = 'none';
            }
            if (!isAdmin) {
                document.querySelectorAll('#settings-dropdown-content .admin-only').forEach(el => {
                    el.style.display = 'none';
                });
                const visibleLinks = settingsDropdownContent.querySelectorAll('a:not([style*="display: none"])');
                if (visibleLinks.length === 0) {
                     settingsDropdown.style.display = 'none';
                }
            } else {
                 document.body.classList.add('admin-mode');
            }
        } catch (e) {
            logout();
        }
        document.getElementById('logout-btn').onclick = logout;

        // --- Globale API-Funktion (unverändert) ---
        async function apiFetch(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
            if (body) { options.body = JSON.stringify(body); }
            const response = await fetch(API_URL + endpoint, options);
            if (response.status === 401 || response.status === 403) { logout(); throw new Error('Sitzung ungültig oder fehlende Rechte.'); }
            const contentType = response.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) { data = await response.json(); } else { data = { message: await response.text() }; }
            if (!response.ok) { throw new Error(data.message || 'API-Fehler'); }
            return data;
        }

        // --- Laden der Farbeinstellungen (unverändert) ---
        async function loadColorSettings() {
             let fetchedColors = DEFAULT_COLORS;
            try {
                const data = await apiFetch('/api/settings', 'GET');
                for(const key in DEFAULT_COLORS) {
                    if (data[key] !== undefined && data[key] !== null) {
                        fetchedColors[key] = data[key];
                    } else {
                         fetchedColors[key] = DEFAULT_COLORS[key];
                    }
                }
                colorSettings = fetchedColors;
            } catch (error) {
                 console.error("Fehler beim Laden der globalen Einstellungen:", error.message);
                 colorSettings = DEFAULT_COLORS;
            }
            const root = document.documentElement.style;
            for (const key in colorSettings) {
                root.setProperty(`--${key.replace(/_/g, '-')}`, colorSettings[key]);
            }
        }

        // --- MODAL-LOGIK (unverändert) ---
        function closeModal(modalEl) {
            modalEl.style.display = 'none';
        }
        function openShiftModal(userId, dateStr, userName) {
            if (!isAdmin) { return; }
            const d = new Date(dateStr);
            const dateDisplay = d.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit' });
            modalContext = { userId, dateStr };
            shiftModalTitle.textContent = "Schicht zuweisen";
            shiftModalInfo.textContent = `Für: ${userName} am ${dateDisplay}`;
            shiftModal.style.display = 'block';
        }
        closeShiftModalBtn.onclick = () => closeModal(shiftModal);
        window.onclick = (event) => {
            if (event.target == shiftModal) closeModal(shiftModal);
        }

        // --- Laden aller Sondertermine (unverändert) ---
        async function loadSpecialDates(year) {
             try {
                const holidays = await apiFetch(`/api/special_dates?type=holiday&year=${year}`);
                const training = await apiFetch(`/api/special_dates?type=training&year=${year}`);
                const shooting = await apiFetch(`/api/special_dates?type=shooting&year=${year}`);

                currentSpecialDates = {};
                training.forEach(d => { if(d.date) currentSpecialDates[d.date] = d.type; });
                shooting.forEach(d => { if(d.date) currentSpecialDates[d.date] = d.type; });
                holidays.forEach(d => { if(d.date) currentSpecialDates[d.date] = 'holiday'; });

            } catch (error) {
                 console.error("Fehler beim Laden der Sondertermine:", error.message);
            }
        }


        // --- HAUPT-RENDER-LOGIK (ANGEPASST) ---
        async function renderGrid() {
            monthLabel.textContent = "Lade...";
            grid.innerHTML = '<div style="padding: 20px; text-align: center; color: #333;">Lade Daten...</div>';
            staffingGrid.innerHTML = '';
            try {
                const shiftDataPromise = apiFetch(`/api/shifts?year=${currentYear}&month=${currentMonth}`);
                const userDataPromise = apiFetch('/api/users');
                const specialDatesPromise = loadSpecialDates(currentYear);

                const [shiftPayload, userData, specialDatesResult] = await Promise.all([shiftDataPromise, userDataPromise, specialDatesPromise]);

                allUsers = userData;

                // Schichten DIESES Monats
                currentShifts = {};
                shiftPayload.shifts.forEach(s => {
                    const key = `${s.user_id}-${s.date}`;
                    const fullShiftType = allShiftTypes[s.shifttype_id];
                    currentShifts[key] = {
                        ...s,
                        shift_type: fullShiftType
                    };
                });

                // --- NEU: Schichten VORMONAT (Übertrag) ---
                currentShiftsLastMonth = {};
                if (shiftPayload.shifts_last_month) {
                    shiftPayload.shifts_last_month.forEach(s => {
                        // Wir brauchen nur eine Schicht pro User (die letzte)
                        const fullShiftType = allShiftTypes[s.shifttype_id];
                        currentShiftsLastMonth[s.user_id] = {
                            ...s,
                            shift_type: fullShiftType
                        };
                    });
                }
                // --- ENDE NEU ---

                currentTotals = shiftPayload.totals;

                currentViolations.clear();
                if (shiftPayload.violations) {
                    shiftPayload.violations.forEach(v => {
                        currentViolations.add(`${v[0]}-${v[1]}`);
                    });
                }

                currentStaffingActual = shiftPayload.staffing_actual || {};

                buildGridDOM();
                buildStaffingTable();

                // (Sortierung in dieser Version deaktiviert)
                // initializeSortable();

            } catch (error) {
                grid.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Fehler beim Laden des Plans: ${error.message}</div>`;
            }
        }

        // --- buildGridDOM (ANGEPASST) ---
        function buildGridDOM() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const monthName = new Date(currentYear, currentMonth - 1, 1).toLocaleString('de-DE', { month: 'long', year: 'numeric' });
            monthLabel.textContent = monthName;

            // --- ANPASSUNG (Regel 2): gridTemplateColumns ---
            grid.style.gridTemplateColumns = `${COL_WIDTH_NAME} ${COL_WIDTH_DETAILS} ${COL_WIDTH_UEBERTRAG} repeat(${daysInMonth}, ${COL_WIDTH_DAY}) ${COL_WIDTH_TOTAL}`;

            grid.innerHTML = '';
            const weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

            const renderDayHeader = (day, isWeekend, dateStr) => {
                const eventType = currentSpecialDates[dateStr];
                const headerCell = document.createElement('div');
                let headerClasses = 'grid-header';
                if (eventType) {
                    headerClasses += ` day-color-${eventType}`;
                } else if (isWeekend) {
                    headerClasses += ' weekend';
                }
                headerCell.className = headerClasses;
                return headerCell;
            };

            // --- ANPASSUNG: Header-Zeile 1 (Wochentage) ---
            let nameHeader1 = document.createElement('div');
            nameHeader1.className = 'grid-header';
            grid.appendChild(nameHeader1);
            let dogHeader1 = document.createElement('div');
            dogHeader1.className = 'grid-header';
            grid.appendChild(dogHeader1);

            // NEU: Header 1 für Übertrag
            let uebertragHeader1 = document.createElement('div');
            uebertragHeader1.className = 'grid-header-uebertrag';
            grid.appendChild(uebertragHeader1);

            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(currentYear, currentMonth - 1, day);
                const dayName = weekdays[d.getDay()];
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const headerCell = renderDayHeader(day, isWeekend, dateStr);
                headerCell.textContent = dayName;
                grid.appendChild(headerCell);
            }
            let totalHeader1 = document.createElement('div');
            totalHeader1.className = 'grid-header-total';
            grid.appendChild(totalHeader1);

            // --- ANPASSUNG: Header-Zeile 2 (Tage) ---
            let nameHeader2 = document.createElement('div');
            nameHeader2.className = 'grid-header-dog';
            nameHeader2.textContent = 'Mitarbeiter';
            grid.appendChild(nameHeader2);
            const dogHeader = document.createElement('div');
            dogHeader.className = 'grid-header-dog';
            dogHeader.textContent = 'Diensthund';
            grid.appendChild(dogHeader);

            // NEU: Header 2 für Übertrag
            const uebertragHeader = document.createElement('div');
            uebertragHeader.className = 'grid-header-uebertrag';
            uebertragHeader.textContent = 'Ü';
            uebertragHeader.title = 'Übertrag Vormonat';
            grid.appendChild(uebertragHeader);

            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(currentYear, currentMonth - 1, day);
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const headerCell = renderDayHeader(day, isWeekend, dateStr);
                headerCell.textContent = day;
                grid.appendChild(headerCell);
            }
            const totalHeader = document.createElement('div');
            totalHeader.className = 'grid-header-total';
            totalHeader.textContent = 'Std.';
            grid.appendChild(totalHeader);

            // --- ANPASSUNG: Benutzer-Zellen ---
            const visibleUsers = allUsers.filter(user => user.shift_plan_visible === true);
            visibleUsers.forEach(user => { // 'user' hier ist der gerenderte Benutzer

                // --- NEU (Regel 3): Prüfen, ob dies der eingeloggte Benutzer ist ---
                const isCurrentUser = (loggedInUser && loggedInUser.id === user.id);
                const currentUserClass = isCurrentUser ? ' current-user-row' : '';
                // --- ENDE NEU ---

                const nameCell = document.createElement('div');
                // --- ANPASSUNG ---
                nameCell.className = 'grid-user-name' + currentUserClass;
                nameCell.textContent = `${user.vorname} ${user.name}`;
                grid.appendChild(nameCell);

                const dogCell = document.createElement('div');
                // --- ANPASSUNG ---
                dogCell.className = 'grid-user-dog' + currentUserClass;
                dogCell.textContent = user.diensthund || '---';
                grid.appendChild(dogCell);

                // NEU: Übertrag-Zelle
                const uebertragCell = document.createElement('div');
                // --- ANPASSUNG ---
                uebertragCell.className = 'grid-user-uebertrag' + currentUserClass;
                const lastMonthShift = currentShiftsLastMonth[user.id];
                if (lastMonthShift && lastMonthShift.shift_type) {
                    uebertragCell.textContent = lastMonthShift.shift_type.abbreviation;
                    uebertragCell.title = `Schicht am Vormonat: ${lastMonthShift.shift_type.name}`;
                } else {
                    uebertragCell.textContent = '---';
                }
                grid.appendChild(uebertragCell);
                // --- ENDE NEU ---

                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(currentYear, currentMonth - 1, day);
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const dayOfMonth = String(d.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${dayOfMonth}`;
                    const key = `${user.id}-${dateStr}`;
                    const violationKey = `${user.id}-${day}`;
                    const eventType = currentSpecialDates[dateStr];
                    const shift = currentShifts[key];
                    const shiftType = shift ? shift.shift_type : null;
                    const cell = document.createElement('div');
                    let cellClasses = 'grid-cell';
                    let cellColor = null;
                    let textColor = null;

                    if (currentViolations.has(violationKey)) {
                         cellClasses += ' violation';
                    }
                    const dayHasSpecialBg = eventType || isWeekend;

                    if (shiftType) {
                        cell.textContent = shiftType.abbreviation;
                        if (shiftType.prioritize_background && dayHasSpecialBg) {

                            if (eventType === 'holiday') {
                                cellClasses += ` day-color-${eventType}`;
                            } else if (isWeekend) {
                                cellClasses += ' weekend';
                            }
                        } else {
                            cellColor = shiftType.color;
                            textColor = isColorDark(shiftType.color) ? 'white' : 'black';
                        }
                    } else {
                        cell.textContent = '';
                        if (eventType === 'holiday') {
                             cellClasses += ` day-color-${eventType}`;
                        } else if (isWeekend) {
                            cellClasses += ' weekend';
                        }
                    }

                    // --- ANPASSUNG (Regel 3) ---
                    cell.className = cellClasses + currentUserClass;
                    // --- ENDE ANPASSUNG ---

                    if (cellColor) { cell.style.backgroundColor = cellColor; }
                    if (textColor) { cell.style.color = textColor; }
                    cell.dataset.key = key;

                    if (isAdmin) {
                        cell.onclick = () => {
                            openShiftModal(user.id, dateStr, `${user.vorname} ${user.name}`);
                        };
                        cell.onmouseenter = () => {
                            cell.classList.add('hovered');
                            hoveredCellContext = {
                                userId: user.id, dateStr: dateStr,
                                userName: `${user.vorname} ${user.name}`,
                                cellElement: cell
                            };
                        };
                        cell.onmouseleave = () => {
                            cell.classList.remove('hovered');
                            hoveredCellContext = null;
                        };
                    } else {
                        cell.style.cursor = 'default';
                    }
                    grid.appendChild(cell);
                }
                const totalCell = document.createElement('div');
                // --- ANPASSUNG (Regel 3) ---
                totalCell.className = 'grid-user-total' + currentUserClass;
                // --- ENDE ANPASSUNG ---
                totalCell.id = `total-hours-${user.id}`;
                const userTotalHours = currentTotals[user.id] || 0.0;
                totalCell.textContent = userTotalHours.toFixed(1);
                grid.appendChild(totalCell);
            });
        }

        // --- buildStaffingTable (ANGEPASST) ---
        function buildStaffingTable() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            // 1. Finde relevante Schichtarten (SOLL > 0 an irgendeinem Tag)
            const relevantShiftTypes = Object.values(allShiftTypes).filter(st =>
                (st.min_staff_mo || 0) > 0 || (st.min_staff_di || 0) > 0 ||
                (st.min_staff_mi || 0) > 0 || (st.min_staff_do || 0) > 0 ||
                (st.min_staff_fr || 0) > 0 || (st.min_staff_sa || 0) > 0 ||
                (st.min_staff_so || 0) > 0 || (st.min_staff_holiday || 0) > 0
            );

            if (relevantShiftTypes.length === 0) {
                staffingGridContainer.style.display = 'none';
                return;
            }

            staffingGridContainer.style.display = 'block';

            // --- ANPASSUNG (Regel 2): gridTemplateColumns ---
            staffingGrid.style.gridTemplateColumns = `${COL_WIDTH_NAME} ${COL_WIDTH_DETAILS} ${COL_WIDTH_UEBERTRAG} repeat(${daysInMonth}, ${COL_WIDTH_DAY}) ${COL_WIDTH_TOTAL}`;
            staffingGrid.innerHTML = ''; // (Grid leeren, nicht den Body)

            // Map für Wochentage (JS: 0=So, 1=Mo... 6=Sa) zu unseren DB-Feldern
            const dayKeyMap = [
                'min_staff_so', // 0
                'min_staff_mo', // 1
                'min_staff_di', // 2
                'min_staff_mi', // 3
                'min_staff_do', // 4
                'min_staff_fr', // 5
                'min_staff_sa'  // 6
            ];

            // NEU (Feedback 3): Sortiere die Zeilen alphabetisch nach Kürzel
            // (Wir pausieren die D&D-Sortierung, bis die Basis funktioniert)
            relevantShiftTypes.sort((a, b) => a.abbreviation.localeCompare(b.abbreviation));

            // --- Daten-Zeilen (pro Schichtart) ---
            relevantShiftTypes.forEach(st => {
                const st_id = st.id;

                // 1. Label-Zelle
                let labelCell = document.createElement('div');
                labelCell.className = 'staffing-label';

                // NEU (Feedback 1): Bessere Beschriftung
                labelCell.textContent = `${st.abbreviation} (${st.name})`;
                labelCell.style.fontWeight = '700';
                labelCell.style.color = '#333';
                staffingGrid.appendChild(labelCell);

                // 2. Leere Zelle (für Bündigkeit "Diensthund")
                let emptyCell = document.createElement('div');
                emptyCell.className = 'staffing-cell staffing-untracked';
                staffingGrid.appendChild(emptyCell);

                // --- NEU: Leere Zelle (für Bündigkeit "Ü") ---
                let emptyCellUebertrag = document.createElement('div');
                emptyCellUebertrag.className = 'staffing-cell staffing-untracked';
                emptyCellUebertrag.style.borderRight = '1px solid #ffcc99'; // (Passt zur orangen Spalte)
                staffingGrid.appendChild(emptyCellUebertrag);
                // --- ENDE NEU ---

                let totalIst = 0;
                let totalSoll = 0;

                // 3. Tages-Zellen
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(currentYear, currentMonth - 1, day);
                    const dayOfWeek = d.getDay();
                    const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isHoliday = currentSpecialDates[dateStr] === 'holiday';

                    let sollValue = 0;

                    if (isHoliday) {
                        sollValue = st.min_staff_holiday || 0;
                    } else {
                        const dayKey = dayKeyMap[dayOfWeek];
                        sollValue = st[dayKey] || 0;
                    }
                    totalSoll += sollValue;

                    const istValue = (currentStaffingActual[st_id] && currentStaffingActual[st_id][day] !== undefined)
                                     ? currentStaffingActual[st_id][day]
                                     : 0;
                    totalIst += istValue;

                    const istCell = document.createElement('div');
                    let cellClasses = 'staffing-cell';

                    // --- ANPASSUNG (Regel 4) ---
                    // Die eventType-Färbung (training/shooting) wird hier entfernt,
                    // da sie nur noch den Header betrifft (der hier nicht existiert).
                    // Feiertags-Färbung ist auch nicht nötig, da sie durch die Haupttabelle abgedeckt wird.
                    const eventType = currentSpecialDates[dateStr];
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        cellClasses += ' weekend';
                    }
                    // --- ENDE ANPASSUNG ---


                    // --- NEUE AMPEL-LOGIK + AUSBLENDEN (Feedback 1 & 4) ---
                    if (sollValue === 0) {
                        istCell.textContent = '';
                        cellClasses += ' staffing-untracked'; // Grau
                    } else {
                        istCell.textContent = istValue;
                        if (istValue === sollValue) {
                            cellClasses += ' staffing-ok'; // Grün
                        } else if (istValue > sollValue) {
                             cellClasses += ' staffing-warning'; // Gelb (Überbesetzt)
                        } else if (istValue > 0) {
                            cellClasses += ' staffing-warning'; // Gelb (Unterbesetzt)
                        } else {
                            cellClasses += ' staffing-violation'; // Rot
                        }
                    }
                    // --- ENDE NEUE AMPEL-LOGIK ---

                    istCell.className = cellClasses;
                    staffingGrid.appendChild(istCell);
                }

                // 4. Total-Zelle
                let totalIstCell = document.createElement('div');
                totalIstCell.className = 'staffing-total-header';
                totalIstCell.textContent = totalIst;
                if (totalIst < totalSoll) {
                    totalIstCell.style.color = '#c00000';
                } else if (totalIst > totalSoll && totalSoll > 0) {
                     totalIstCell.style.color = '#856404';
                }
                staffingGrid.appendChild(totalIstCell);
            });
        }
        // --- ENDE KORREKTUR ---

        // --- (SortableJS-Funktionen in dieser Version entfernt) ---

        // --- Helligkeitsprüfung (unverändert) ---
        function isColorDark(hexColor) {
            if (!hexColor) return false;
            const hex = hexColor.replace('#', '');
            if (hex.length !== 6) return false;
            try {
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance < 0.5;
            } catch (e) {
                return false;
            }
        }

        // --- populateStaticElements (ANGEPASST, Sortierung entfernt) ---
        async function populateStaticElements(forceReload = false) {
            if (Object.keys(allShiftTypes).length === 0 || forceReload) {
                const typeData = await apiFetch('/api/shifttypes');
                allShiftTypes = {};
                typeData.forEach(st => allShiftTypes[st.id] = st);
            }

            legend.innerHTML = '<b>Legende:</b>';
            shiftSelection.innerHTML = '';

            // (Verwendet jetzt die unsortierte Objekt-Reihenfolge)
            const sortedTypes = Object.values(allShiftTypes);

            sortedTypes.forEach(st => {
                const item = document.createElement('div');
                item.className = 'legende-item';
                const priorityIndicator = st.prioritize_background ? ' (Hintergrund prior.)' : '';
                item.innerHTML = `<div class="legende-color" style="background-color: ${st.color};"></div> ${st.abbreviation} (${st.name}${priorityIndicator})`;
                legend.appendChild(item);
                if (!isVisitor) {
                    const btn = document.createElement('button');
                    btn.textContent = `${st.abbreviation} (${st.name})`;
                    btn.style.backgroundColor = st.color;
                    if (isColorDark(st.color)) {
                        btn.style.color = 'white';
                    } else {
                        btn.style.color = 'black';
                    }
                    btn.onclick = () => saveShift(st.id, modalContext.userId, modalContext.dateStr);
                    shiftSelection.appendChild(btn);
                }
            });
        }

        // --- DATEN SPEICHERN (unverändert) ---
        async function saveShift(shifttypeId, userId, dateStr) {
            if (!isAdmin) {
                console.error("Nicht-Admins dürfen keine Schichten speichern.");
                return;
            }
            if (!userId || !dateStr) return;
            const key = `${userId}-${dateStr}`;
            const cell = findCellByKey(key);
            try {
                if(cell) cell.textContent = '...';
                const savedData = await apiFetch('/api/shifts', 'POST', {
                    user_id: userId,
                    date: dateStr,
                    shifttype_id: shifttypeId
                });
                closeModal(shiftModal);

                const shiftType = allShiftTypes[savedData.shifttype_id];
                const shiftWasDeleted = savedData.message && (savedData.message.includes("gelöscht") || savedData.message.includes("bereits Frei"));

                if (shiftWasDeleted) {
                    currentShifts[key] = null;
                } else if (shiftType) {
                    currentShifts[key] = {
                        ...savedData,
                        shift_type: shiftType
                    };
                } else {
                     currentShifts[key] = savedData;
                }

                currentViolations.clear();
                if (savedData.violations) {
                    savedData.violations.forEach(v => {
                        currentViolations.add(`${v[0]}-${v[1]}`);
                    });
                }

                currentStaffingActual = savedData.staffing_actual || {};

                buildGridDOM();
                buildStaffingTable();

                const totalCell = document.getElementById(`total-hours-${userId}`);
                if (totalCell) {
                    totalCell.textContent = (savedData.new_total_hours || 0.0).toFixed(1);
                }

            } catch (error) {
                if (cell) cell.textContent = 'Fehler!';
                alert(`Fehler beim Speichern: ${error.message}`);
                if (shiftModal.style.display === 'block') {
                    shiftModalInfo.textContent = `Fehler: ${error.message}`;
                }
            }
        }

        // (findCellByKey - unverändert)
        function findCellByKey(key) {
            return grid.querySelector(`[data-key="${key}"]`);
        }

        // --- NAVIGATIONS-EVENTS (unverändert) ---
        prevMonthBtn.onclick = () => {
            currentMonth--;
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            loadColorSettings();
            renderGrid();
        };
        nextMonthBtn.onclick = () => {
            currentMonth++;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            loadColorSettings();
            renderGrid();
        };

        // --- Shortcut Ladefunktion (unverändert) ---
        function loadShortcuts() {
            let savedShortcuts = {};
            try {
                const data = localStorage.getItem(SHORTCUT_STORAGE_KEY);
                if (data) {
                    savedShortcuts = JSON.parse(data);
                }
            } catch (e) {
                console.error("Fehler beim Laden der Shortcuts aus localStorage, verwende Standards.", e);
            }
            const mergedShortcuts = {};
            const allAbbrevs = Object.values(allShiftTypes).map(st => st.abbreviation);
            allAbbrevs.forEach(abbrev => {
                const key = savedShortcuts[abbrev] || defaultShortcuts[abbrev];
                if (key) {
                    mergedShortcuts[abbrev] = key;
                }
            });
            shortcutMap = Object.fromEntries(
                Object.entries(mergedShortcuts).map(([abbrev, key]) => [key, abbrev])
            );
        }

        // --- KEYBOARD SHORTCUT LISTENER (unverändert) ---
        window.addEventListener('keydown', async (event) => {
            if (!isAdmin) return;
            if (shiftModal.style.display === 'block') return;
            if (!hoveredCellContext || !hoveredCellContext.userId) return;
            const key = event.key.toLowerCase();
            const abbrev = shortcutMap[key];
            if (abbrev !== undefined) {
                event.preventDefault();
                const shiftType = Object.values(allShiftTypes).find(st => st.abbreviation === abbrev);
                if (shiftType) {
                    await saveShift(shiftType.id, hoveredCellContext.userId, hoveredCellContext.dateStr);
                } else {
                    console.warn(`Shortcut "${key}" (Abk.: "${abbrev}") nicht in allShiftTypes gefunden.`);
                }
            }
        });

        // --- Initialisierung (unverändert) ---
        async function initialize() {
            await loadColorSettings();
            await populateStaticElements();
            loadShortcuts();
            await renderGrid();
        }

        initialize();

    </script>
</body>
</html>